"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1778],{47469:(e,r,t)=>{t.d(r,{F:()=>b,PlayerProvider:()=>y});var n=t(81556),a=t(47256),l=t(85110),o=t(91765),u=t(754),c=t(85550),i=t(83576),s=t(7241);let d=(0,a.createContext)(void 0),g={VOLUME:"artogo_player_volume",PLAYBACK_SPEED:"artogo_player_speed"},p=(e,r)=>{try{let t=localStorage.getItem(e);return t?JSON.parse(t):r}catch(e){return r}},k=(e,r)=>{try{localStorage.setItem(e,JSON.stringify(r))}catch(e){}},y=e=>{let{children:r}=e,[t,y]=(0,a.useState)({currentTrack:null,isPlaying:!1,progress:0,currentTime:0,visible:!1,playlist:[],currentIndex:-1,playbackSpeed:p(g.PLAYBACK_SPEED,1),volume:p(g.VOLUME,1),muted:!1,playbackMode:"list",isExpanded:!1,showSignLanguagePlayer:!1,currentAudioIndex:0,workCategories:[]}),[b,m]=(0,a.useState)(null),h=(0,a.useRef)({}),I=(0,a.useRef)(new Set),C=(0,a.useRef)(0),v=(0,a.useRef)({progress:0,currentTime:0}),f=(0,a.useRef)(new Set);(0,a.useEffect)(()=>{i.El.hasRun(i.El.KEYS.PLAYER_HISTORY)||(i.El.markAsRun(i.El.KEYS.PLAYER_HISTORY),(async()=>{try{let e=await (0,l.BJ)(),r={};e.forEach(e=>{r[e.contentID]=e}),h.current=r}catch(e){o.vF.error("Failed to load play history",{error:e}),o.errorTracker.report(e,{errorCode:c.F4.FILE_READ_ERROR,component:"PlayerContext",action:"loadPlayHistory",severity:u.MU.LOW})}})())},[]);let P=(0,a.useCallback)(async e=>{var r,t;C.current=0;let n=e.contents[0],a=0,i=0,s=0;if(n)try{let r=h.current[n.id]||null;if(o.vF.debug("[PlayerContext] play - checking history from ref",{trackId:e.id,contentId:n.id,hasHistoryInRef:!!r,refKeys:Object.keys(h.current)}),!r&&(r=await (0,l.k3)(e.id,n.id),o.vF.debug("[PlayerContext] play - checking history from Preferences (exact match)",{trackId:e.id,contentId:n.id,hasHistoryInPreferences:!!r,historyData:r?{progress:r.progress,progressPercent:r.progressPercent}:null}),r||(r=await (0,l.k3)(e.id),o.vF.debug("[PlayerContext] play - checking history from Preferences (workID only)",{trackId:e.id,hasHistoryInPreferences:!!r,historyData:r?{progress:r.progress,progressPercent:r.progressPercent,contentID:r.contentID}:null}))),o.vF.debug("[PlayerContext] play - playHistory details",{trackId:e.id,hasPlayHistory:!!r,isCompleted:null==r?void 0:r.isCompleted,historyProgress:null==r?void 0:r.progress,historyContentID:null==r?void 0:r.contentID,trackContentsIds:e.contents.map(e=>e.id)}),r&&!r.isCompleted){let t=e.contents.findIndex(e=>e.id===r.contentID);o.vF.debug("[PlayerContext] play - content matching",{contentIndex:t,willResume:-1!==t||e.contents.length>0}),-1!==t?(s=t,a=r.progressPercent,i=r.progress):e.contents.length>0?(s=0,a=r.progressPercent,i=r.progress):o.vF.warn("Content not found in track and no contents available",{contentID:r.contentID}),o.vF.debug("[PlayerContext] play - resume values",{resumeAudioIndex:s,resumeProgress:a,resumeTime:i})}}catch(r){o.vF.error("Failed to load play history",{error:r}),o.errorTracker.report(r,{errorCode:c.F4.FILE_READ_ERROR,component:"PlayerContext",action:"play-loadHistory",severity:u.MU.LOW,metadata:{trackId:e.id}})}let d="sign_language"===e.contentVersionType;o.vF.debug("[PlayerContext] play - Sign language check",{trackId:e.id,contentVersionType:e.contentVersionType,isSignLanguageContent:d,contentsLength:e.contents.length,firstContentUrl:null==(t=e.contents[0])||null==(r=t.url)?void 0:r.substring(0,50)}),y(r=>({...r,currentTrack:e,isPlaying:!0,progress:a,currentTime:i,currentAudioIndex:s,visible:!0,showSignLanguagePlayer:d})),v.current={progress:a,currentTime:i},f.current.forEach(e=>e()),i>0&&m(i)},[]),D=(0,a.useCallback)(()=>{y(e=>({...e,isPlaying:!1}))},[]),x=(0,a.useCallback)(()=>{y(e=>({...e,isPlaying:!0}))},[]),E=(0,a.useCallback)(()=>{y(e=>({...e,isPlaying:!e.isPlaying}))},[]),T=(0,a.useCallback)(async()=>{if(0===t.playlist.length)return;let e=(t.currentIndex+1)%t.playlist.length,r=t.playlist[e];y(r=>({...r,currentIndex:e})),await P(r)},[t,P]),R=(0,a.useCallback)(async()=>{if(0===t.playlist.length)return;let e=0===t.currentIndex?t.playlist.length-1:t.currentIndex-1,r=t.playlist[e];y(r=>({...r,currentIndex:e})),await P(r)},[t,P]),w=(0,a.useCallback)(e=>(f.current.add(e),()=>{f.current.delete(e)}),[]),L=(0,a.useCallback)(()=>v.current,[]),S=(0,a.useCallback)(e=>(I.current.add(e),()=>{I.current.delete(e)}),[]),_=(0,a.useCallback)(()=>h.current,[]),A=(0,a.useRef)(null),M=(0,a.useRef)(0);(0,a.useEffect)(()=>{A.current=t.currentTrack,M.current=t.currentAudioIndex},[t.currentTrack,t.currentAudioIndex]);let F=(0,a.useCallback)((e,r)=>{v.current={progress:e,currentTime:r},f.current.forEach(e=>e());let t=A.current,n=M.current;if(!t)return;let a=Date.now(),i=a-C.current,s=e>=99;if(!(i>=1e3||s||0===C.current))return;let d=t.contents[n];if(d){let n=d.duration||0,i={workID:t.id,contentID:d.id,title:t.title,thumbnail:t.thumbnail,floor:t.floor,room:t.room,has3DModel:t.has3DModel,progress:r,duration:n,progressPercent:e,isCompleted:s};(0,l.IO)(i).catch(t=>{o.errorTracker.report(t,{errorCode:c.F4.FILE_WRITE_ERROR,component:"PlayerContext",action:"updateProgress",severity:u.MU.LOW,metadata:{progress:e,currentTime:r}})}),h.current={...h.current,[d.id]:{...i,lastPlayedAt:new Date}},I.current.forEach(e=>e()),C.current=a}},[]),O=(0,a.useCallback)(e=>{var r;m(e);let n=null==(r=t.currentTrack)?void 0:r.contents[t.currentAudioIndex],a=(null==n?void 0:n.duration)||0,i=a>0?e/a*100:0;if(y(r=>({...r,progress:i,currentTime:e})),v.current={progress:i,currentTime:e},f.current.forEach(e=>e()),t.currentTrack&&n){let r={workID:t.currentTrack.id,contentID:n.id,title:t.currentTrack.title,thumbnail:t.currentTrack.thumbnail,floor:t.currentTrack.floor,room:t.currentTrack.room,has3DModel:t.currentTrack.has3DModel,progress:e,duration:a,progressPercent:i,isCompleted:i>=99};(0,l.IO)(r).catch(r=>{o.errorTracker.report(r,{errorCode:c.F4.FILE_WRITE_ERROR,component:"PlayerContext",action:"seek",severity:u.MU.LOW,metadata:{time:e,newProgress:i}})}),h.current={...h.current,[n.id]:{...r,lastPlayedAt:new Date}},I.current.forEach(e=>e())}},[t.currentTrack,t.currentAudioIndex]),U=(0,a.useCallback)(e=>{var r;let n=null==(r=t.currentTrack)?void 0:r.contents[t.currentAudioIndex],a=(null==n?void 0:n.duration)||0;O(Math.min(v.current.currentTime+e,a))},[t.currentTrack,t.currentAudioIndex,O]),Y=(0,a.useCallback)(e=>{O(Math.max(v.current.currentTime-e,0))},[O]),H=(0,a.useCallback)(function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;y(t=>({...t,playlist:e,currentIndex:r,currentTrack:e[r]||null}))},[]),N=(0,a.useCallback)(()=>{y(e=>({currentTrack:null,isPlaying:!1,progress:0,currentTime:0,visible:!1,playlist:[],currentIndex:-1,playbackSpeed:e.playbackSpeed,volume:e.volume,muted:e.muted,playbackMode:e.playbackMode,isExpanded:!1,showSignLanguagePlayer:!1,currentAudioIndex:0,workCategories:[]}))},[]),K=(0,a.useCallback)(()=>{y(e=>({...e,visible:!0}))},[]),V=(0,a.useCallback)(()=>{y(e=>({...e,visible:!1}))},[]),W=(0,a.useCallback)(e=>{y(r=>({...r,playbackSpeed:e})),k(g.PLAYBACK_SPEED,e)},[]),B=(0,a.useCallback)(e=>{let r=Math.max(0,Math.min(1,e));y(e=>({...e,volume:r,muted:0===r})),k(g.VOLUME,r)},[]),J=(0,a.useCallback)(()=>{y(e=>({...e,muted:!e.muted}))},[]),j=(0,a.useCallback)(e=>{y(r=>({...r,playbackMode:e}))},[]),q=(0,a.useCallback)(()=>{y(e=>({...e,isExpanded:!0}))},[]),z=(0,a.useCallback)(()=>{y(e=>({...e,isExpanded:!1}))},[]),G=(0,a.useCallback)(()=>{y(e=>({...e,isExpanded:!e.isExpanded}))},[]),Q=(0,a.useCallback)(()=>{y(e=>({...e,showSignLanguagePlayer:!0}))},[]),X=(0,a.useCallback)(()=>{y(e=>({...e,showSignLanguagePlayer:!1,isPlaying:!1}))},[]),Z=(0,a.useCallback)(e=>{y(r=>({...r,currentAudioIndex:e,progress:0,currentTime:0}))},[]),$=(0,a.useCallback)(e=>{y(r=>{if(!r.currentTrack)return r;let t=[...r.currentTrack.contents];return t[r.currentAudioIndex]&&(t[r.currentAudioIndex]={...t[r.currentAudioIndex],duration:e}),{...r,currentTrack:{...r.currentTrack,contents:t}}})},[]),ee=(0,a.useCallback)(e=>{y(r=>r.currentTrack?{...r,currentTrack:{...r.currentTrack,contents:e}}:r)},[]),er=(0,a.useCallback)(e=>{y(r=>r.currentTrack?{...r,currentTrack:{...r.currentTrack,...e}}:r)},[]),et=(0,a.useCallback)(e=>{var r;o.vF.debug("[PlayerContext] setWorkCategories called",{categoriesLength:null!=(r=null==e?void 0:e.length)?r:0,categoriesData:null==e?void 0:e.map(e=>{var r,t;return{name:e.categoryName,worksCount:null!=(t=null==(r=e.works)?void 0:r.length)?t:0}})}),y(r=>({...r,workCategories:e}))},[]),{version:en,personalDataVersion:ea}=(0,s.t)(),el=(0,a.useRef)(null),eo=(0,a.useRef)(ea);(0,a.useEffect)(()=>{eo.current!==ea&&(o.vF.info("[PlayerContext] Personal data version changed, clearing play history cache and closing player",{from:eo.current,to:ea}),h.current={},v.current={progress:0,currentTime:0},I.current.forEach(e=>e()),i.El.reset(i.El.KEYS.PLAYER_HISTORY),y(e=>({currentTrack:null,isPlaying:!1,progress:0,currentTime:0,visible:!1,playlist:[],currentIndex:-1,playbackSpeed:e.playbackSpeed,volume:e.volume,muted:e.muted,playbackMode:e.playbackMode,isExpanded:!1,showSignLanguagePlayer:!1,currentAudioIndex:0,workCategories:[]})),eo.current=ea)},[ea]),(0,a.useEffect)(()=>{if(null===el.current){el.current=en;return}el.current!==en&&(o.vF.info("[PlayerContext] Version changed, closing player",{from:el.current,to:en}),y({currentTrack:null,isPlaying:!1,progress:0,currentTime:0,visible:!1,playlist:[],currentIndex:-1,playbackSpeed:t.playbackSpeed,volume:t.volume,muted:t.muted,playbackMode:t.playbackMode,isExpanded:!1,showSignLanguagePlayer:!1,currentAudioIndex:0,workCategories:[]}),el.current=en)},[en,t.playbackSpeed,t.volume,t.muted,t.playbackMode]);let eu=(0,a.useMemo)(()=>({...t,play:P,pause:D,resume:x,togglePlayPause:E,next:T,previous:R,updateProgress:F,seek:O,skipForward:U,skipBackward:Y,setPlaylist:H,close:N,show:K,hide:V,setSpeed:W,setVolume:B,toggleMute:J,setMode:j,expand:q,collapse:z,toggleExpanded:G,openSignLanguagePlayer:Q,closeSignLanguagePlayer:X,setAudioIndex:Z,seekTime:b,setSeekTime:m,updateTrackDuration:$,updateTrackContents:ee,updateTrack:er,setWorkCategories:et,subscribeToProgress:w,getProgressSnapshot:L,subscribeToPlayHistory:S,getPlayHistorySnapshot:_}),[t,P,D,x,E,T,R,F,O,U,Y,H,N,K,V,W,B,J,j,q,z,G,Q,X,Z,b,$,ee,er,et,w,L,S,_]);return(0,n.jsx)(d.Provider,{value:eu,children:r})},b=()=>{let e=(0,a.useContext)(d);if(!e)throw Error("usePlayer must be used within PlayerProvider");return e}},71526:(e,r,t)=>{t.d(r,{S:()=>o});var n=t(47256),a=t(7241),l=t(40014);function o(){let{version:e}=(0,a.t)(),r=(0,n.useMemo)(()=>(0,l.DJ)(e),[e]),t=(0,n.useMemo)(()=>{switch(r){case"sign_language":return"sign_language";case"audio_description":return"audio_description";default:return"audio"}},[r]),o=(0,n.useCallback)(e=>{switch(r){case"sign_language":return{url:e.signLanguageUrl,contentID:e.signLanguageContentID,duration:e.signLanguageDuration};case"audio_description":return{url:e.audioDescriptionUrl,contentID:e.audioDescriptionContentID,duration:e.audioDescriptionDuration};default:return{url:e.audioUrl,contentID:e.audioContentID,duration:e.audioDuration}}},[r]),u=(0,n.useCallback)(e=>{switch(r){case"sign_language":return{url:e.signLanguageURL,contentID:e.signLanguageContentID,duration:e.signLanguageDuration};case"audio_description":return{url:e.audioDescriptionURL,contentID:e.audioDescriptionContentID,duration:e.audioDescriptionDuration};default:return{url:e.audioURL,contentID:e.audioContentID,duration:e.audioDuration}}},[r]),c=(0,n.useCallback)(e=>{var r;let n=o(e);return n.url&&n.contentID?{id:n.contentID,type:t,url:n.url,duration:null!=(r=n.duration)?r:0,status:"available"}:null},[o,t]),i=(0,n.useCallback)((e,t)=>{var n,a;let l=c(e);return{id:e.workID,title:e.title,thumbnail:e.image,exhibitionID:null!=(n=e.exhibitionID)?n:null==t?void 0:t.exhibitionID,exhibitionName:null!=(a=e.exhibitionName)?a:null==t?void 0:t.exhibitionName,bannerImage:null==t?void 0:t.bannerImage,floor:e.floor,room:e.room,spaceUid:e.spaceUid,mapLocation:e.mapLocation,has3DModel:e.has3DModel,contentVersionType:r,contents:l?[l]:[]}},[r,c]),s=(0,n.useCallback)((e,r)=>e.map(e=>i(e,r)),[i]);return{version:e,contentVersionType:r,mediaType:t,getMediaInfoByVersion:o,getMediaInfoFromSearchResult:u,workToTrack:i,worksToPlaylist:s,createContent:c}}}}]);