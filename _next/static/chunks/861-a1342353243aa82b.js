"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[861],{50861:(e,t,n)=>{n.d(t,{MV:()=>I,Xd:()=>c,vN:()=>_});var a=n(81556),l=n(47256),o=n(97290),i=n(7241),r=n(83576),s=n(91765),u=n(47077);let d=(0,l.createContext)(null);function c(e){let{children:t}=e,{hasLocalPackage:c,isCheckingPackage:_,downloadProgress:I,downloadPackageData:f,refreshPackageStatus:E}=(0,i.t)(),[w,p]=(0,l.useState)({status:"checking",showWelcome:!1,venues:[],selectedVenue:null,downloadProgress:null,error:null,networkType:null});(0,l.useEffect)(()=>{I&&p(e=>JSON.stringify(e.downloadProgress)===JSON.stringify(I)?e:{...e,downloadProgress:I})},[I]);let v=(0,l.useCallback)(async()=>{p(e=>({...e,status:"loading_venues",error:null}));try{s.vF.info("[InitialSetup] Fetching system info for venues from server...");let e=await (0,u.NI)();if(!(null==e?void 0:e.venues)||0===e.venues.length)throw Error("No venues available");let t=e.venues;s.vF.info("[InitialSetup] Found venues",{count:t.length});let n=null,a=o.$W.offlineMode.defaultVenueUid;s.vF.info("[InitialSetup] Checking default venue config",{defaultVenueUid:a,hasDefaultVenueUid:!!a,venueUids:t.map(e=>e.uid)}),a&&((n=t.find(e=>e.uid===a)||null)?s.vF.info("[InitialSetup] Auto-selected default venue",{uid:n.uid,name:n.name}):s.vF.warn("[InitialSetup] Default venue not found in list",{defaultUid:a,availableUids:t.map(e=>e.uid)})),p(e=>({...e,status:"needs_setup",showWelcome:!0,venues:t,selectedVenue:n}))}catch(e){s.vF.error("[InitialSetup] Failed to load venues",{error:e}),p(t=>({...t,status:"error",error:e instanceof Error?e.message:"無法載入場館列表"}))}},[]),[S,T]=(0,l.useState)(!1),P=(0,l.useCallback)(async()=>{if(!o.$W.features.offlineMode){s.vF.debug("[InitialSetup] Offline mode disabled, skipping setup check"),window.__INITIAL_SETUP_COMPLETED__=!0,r.El.setCachedValue("__INITIAL_SETUP_COMPLETED__",!0),p(e=>({...e,status:"ready",showWelcome:!1}));return}s.vF.info("[InitialSetup] Checking if local package exists...",{hasLocalPackage:c}),c?(s.vF.info("[InitialSetup] Local package found, ready to use"),window.__INITIAL_SETUP_COMPLETED__=!0,r.El.setCachedValue("__INITIAL_SETUP_COMPLETED__",!0),p(e=>({...e,status:"ready",showWelcome:!1}))):(s.vF.info("[InitialSetup] No local package, loading venues..."),await v())},[v,c]),g=(0,l.useRef)(!1);(0,l.useEffect)(()=>{if(_)return;if(window.__INITIAL_SETUP_COMPLETED__&&c)return void p(e=>"ready"===e.status?e:{...e,status:"ready",showWelcome:!1});window.__INITIAL_SETUP_COMPLETED__&&!c&&(s.vF.warn("[InitialSetup] Window flag indicates setup completed but no local package found, resetting..."),window.__INITIAL_SETUP_COMPLETED__=!1);let e=r.El.getCachedValue("__INITIAL_SETUP_COMPLETED__"),t=r.El.getCachedValue("__HAS_LOCAL_PACKAGE__");if(e&&c||e&&!c&&t){window.__INITIAL_SETUP_COMPLETED__=!0,p(e=>"ready"===e.status?e:{...e,status:"ready",showWelcome:!1});return}if(e&&!c&&(s.vF.warn("[InitialSetup] Cache indicates setup completed but no local package found, resetting..."),r.El.setCachedValue("__INITIAL_SETUP_COMPLETED__",!1)),r.El.hasRun(r.El.KEYS.INITIAL_SETUP)){if(c)return void p(e=>"ready"===e.status?e:{...e,status:"ready",showWelcome:!1});s.vF.warn("[InitialSetup] initGuard indicates already run but no local package, re-running check..."),r.El.reset(r.El.KEYS.INITIAL_SETUP)}g.current&&c||(g.current=!0,r.El.markAsRun(r.El.KEYS.INITIAL_SETUP),P())},[P,_,c]);let C=(0,l.useCallback)(e=>{s.vF.info("[InitialSetup] User selected venue",{uid:e.uid,name:e.name}),p(t=>({...t,selectedVenue:e}))},[]),h=(0,l.useCallback)(async e=>{p(e=>({...e,status:"downloading",downloadProgress:{status:"downloading_json",totalFiles:0,completedFiles:0,overallProgress:0},error:null}));let t=e.uid,n=String(e.version_code);s.vF.info("[InitialSetup] Starting package download",{venueUid:t,version:n});let a=await f(t,n);a.success?(s.vF.info("[InitialSetup] Package download completed"),await E(),window.__INITIAL_SETUP_COMPLETED__=!0,r.El.setCachedValue("__INITIAL_SETUP_COMPLETED__",!0),p(e=>({...e,status:"ready",showWelcome:!1,downloadProgress:null}))):(s.vF.error("[InitialSetup] Download failed",{error:a.error}),p(e=>({...e,status:"error",error:a.error||"下載失敗"})))},[f,E]),k=(0,l.useCallback)(async()=>{let e=await new Promise(e=>{p(t=>(e(t.selectedVenue),t))});if(!e){s.vF.error("[InitialSetup] Cannot start download: no venue selected"),p(e=>({...e,status:"error",error:"請先選擇場館"}));return}let{checkNetworkType:t}=await Promise.resolve().then(n.bind(n,22430)),a=await t();if(s.vF.info("[InitialSetup] Network check result",{connected:a.connected,connectionType:a.connectionType}),!a.connected)return void p(e=>({...e,status:"error",error:"no_network"}));if("wifi"!==a.connectionType&&!o.$W.offlineMode.autoDownload){s.vF.info("[InitialSetup] Not on WiFi, asking for confirmation",{networkType:a.connectionType}),p(e=>({...e,status:"confirm_cellular",networkType:a.connectionType}));return}await h(e)},[h]),m=(0,l.useCallback)(async()=>{let e=await new Promise(e=>{p(t=>(e(t.selectedVenue),t))});if(!e)return void p(e=>({...e,status:"error",error:"請先選擇場館"}));s.vF.info("[InitialSetup] User confirmed cellular download"),await h(e)},[h]),L=(0,l.useCallback)(()=>{s.vF.info("[InitialSetup] User cancelled cellular download"),p(e=>({...e,status:"needs_setup",networkType:null}))},[]),y=(0,l.useCallback)(()=>{s.vF.info("[InitialSetup] User skipped setup"),p(e=>({...e,status:"ready",showWelcome:!1}))},[]),A=(0,l.useCallback)(()=>{p(e=>({...e,status:"checking",error:null,venues:[],selectedVenue:null})),T(!1),P()},[P]),F=(0,l.useCallback)(async()=>{s.vF.info("[InitialSetup] Starting package deletion..."),p(e=>({...e,status:"deleting",showWelcome:!0,error:null}));try{let{clearLocalPackage:e}=await Promise.resolve().then(n.bind(n,33252));await e(),s.vF.info("[InitialSetup] Package deleted successfully"),window.__INITIAL_SETUP_COMPLETED__=!1,r.El.setCachedValue("__INITIAL_SETUP_COMPLETED__",!1),r.El.setCachedValue("__HAS_LOCAL_PACKAGE__",!1),r.El.reset(r.El.KEYS.INITIAL_SETUP),r.El.reset(r.El.KEYS.PACKAGE_STATUS),await E(),T(!1),await v()}catch(e){s.vF.error("[InitialSetup] Failed to delete package",{error:e}),p(t=>({...t,status:"error",error:e instanceof Error?e.message:"刪除失敗"}))}},[E,v]);(0,l.useEffect)(()=>{!S&&"needs_setup"===w.status&&w.selectedVenue&&o.$W.offlineMode.autoDownload&&(s.vF.info("[InitialSetup] AUTO_DOWNLOAD: Automatically starting download",{venueUid:w.selectedVenue.uid,venueName:w.selectedVenue.name}),T(!0),setTimeout(()=>{k()},500))},[w.status,w.selectedVenue,S,k]);let N={...w,selectVenue:C,startDownload:k,confirmCellularDownload:m,cancelCellularDownload:L,skipSetup:y,retry:A,startDeleting:F};return(0,a.jsx)(d.Provider,{value:N,children:t})}function _(){let e=(0,l.useContext)(d);if(!e)throw Error("useInitialSetup must be used within InitialSetupProvider");return e}function I(){let e=(0,l.useContext)(d);return!e||"ready"===e.status}}}]);